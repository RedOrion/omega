<html>
  <head>
    <link rel="stylesheet" type="text/css" href="motel.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="rjr/json.js"></script>
    <script type="text/javascript" src="rjr/jrw.js"></script>
    <script type="text/javascript" src="motel.js"></script>
    <script type="text/javascript">
      var client = new CosmosClient();
      client.onopen = function(){
        //loc = new Location();
        //loc.x=20; loc.y=-30; loc.z=15;
        //client.ws_node.invoke_request('create_location', loc);
                                      
        //client.track_location(2, 5);
        //client.track_location(3, 5);
        //client.get_entity('solarsystem', 'system1');
        //client.get_entity('galaxy', 'galaxy1');

        if(client.current_galaxy != null)
          client.get_entity('galaxy', client.current_galaxy);
        else if(client.current_system != null){
          client.get_entity('solarsystem', client.current_system);
          client.get_entities(client.current_system);
        }else
          client.get_entity('galaxy');
      }
      client.message_received = function(msg){
        //console.log(msg);
      }
      client.onsuccess = function(result){
        if(isArray(result)   &&
           result.length > 0 &&
           result[0].json_class == "Cosmos::Galaxy"){

          data  = "<span id='motel_locations_container_title'>Locations:</span><ul>"
          for(var g=0;g<result.length;++g){
            var galaxy = result[g];
            data += "<li><span id='" + galaxy.name + "' class='entity_title galaxy_title'>" + galaxy.name + "</span></li>";
            data += "<ul>";

            for(var s=0;s<galaxy.solar_systems.length;++s){
              var sname = galaxy.solar_systems[s].name;
              data += "<li>";
              data += "<span id='" + sname + "'class='entity_title solar_system_title'>" + sname + "</span>";
              data += "<ul>";
              for(var p=0;p<galaxy.solar_systems[s].planets.length;++p){
                var pname = galaxy.solar_systems[s].planets[p].name;
                data += "<li>" + pname + "</li>";
              }
              data += "</ul>";
            }
            data += "</ul>";

          }
          data += "</ul>";

          $("#motel_locations_container").html(data);
          $('.galaxy_title').live('click', function(event){
            client.current_galaxy = event.currentTarget.id;
            client.current_system = null;
            client.disconnect();
            client.clear_locations();
            client.connect();
            $('#motel_canvas_container canvas').css('background', 'url("http://localhost/wotel/galaxy.png") no-repeat');
          });
          $('.solar_system_title').live('click', function(event){
            client.current_galaxy = null;
            client.current_system = event.currentTarget.id;
            client.disconnect();
            client.clear_locations();
            client.connect();
            $('#motel_canvas_container canvas').css('background', 'url("http://localhost/wotel/system.png") no-repeat');
          });

        }else if(result.json_class == "Cosmos::Galaxy"){
          for(var s=0; s<result.solar_systems.length; ++s){
            system = result.solar_systems[s];
            system.location.entity = system;
            client.add_location(system.location);
          }

        }else if(result.json_class == "Cosmos::SolarSystem"){
          //client.get_location(result.star.location.id);
          result.star.location.entity = result.star;
          client.add_location(result.star.location);

          for(var p=0; p<result.planets.length; ++p){
            planet = result.planets[p];
            planet.location.entity = planet;
            client.add_location(planet.location);

            //console.log(planet);
            client.track_location(planet.location.id, 5);
          }

          for(var j=0; j<result.jump_gates.length; ++j){
            gate = result.jump_gates[j];
            gate.location.entity = gate;
            client.add_location(gate.location);
          }

        }else if(isArray(result)   &&
           result.length > 0 &&
           (result[0].json_class == "Manufactured::Ship" ||
            result[0].json_class == "Manufactured::Station")){
              for(var e=0;e<result.length;++e){
                var entity = result[e];
                entity.location.entity = entity;
                client.add_location(entity.location);
              }
        }

      }
      client.onfailed = function(error, msg){
        //console.log(error);
        //console.log(msg);
      }
      client.connect();
    </script>
  </head>
  <body>
    <div id="motel_locations_container">Locations:</div>
    <div id="motel_canvas_container">
      <canvas id="motel_canvas" width="1500" height="700"></canvas>
    </div>
    <div id="motel_entity_container"></div>
  </body>
</html>
