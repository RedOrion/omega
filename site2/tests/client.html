<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="http://localhost/omega-test/omega/vendor/jquery-1.7.1.min.js"></script>
  <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
  <script src="http://localhost/omega-test/omega/vendor/jquery.cookie.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>

  <script type="text/javascript" src="http://localhost/omega-test/omega/vendor/rjr/json.js"></script>
  <script type="text/javascript" src="http://localhost/omega-test/omega/vendor/rjr/jrw.js"></script>
  <script type="text/javascript" src="http://localhost/omega-test/omega/omega/client.js"></script>
  <script type="text/javascript" src="http://localhost/omega-test/omega/omega/user.js"></script>

  <script>
  $(document).ready(function(){

function before_each(details){
  // logout user
  logout_user();

  // login user
  var user = new JRObject("Users::User", {id : 'mmorsi', password: 'isromm'});
  login_user(user);
}

//QUnit.moduleStart(before_all);
QUnit.testStart(before_each);
//QUnit.testDone(after_each);
//QUnit.moduleDone(after_all);

module("omega_client");

asyncTest("web_request", 2, function() {
  var user = new JRObject("Users::User", {id : 'admin', password: 'nimda'});
  omega_web_request('users::login', user, function(res, err){
    //ok('im awesome');
    equal(null, err);
    equal('Users::Session', res.json_class);
    start();
  });
});

asyncTest("ws request", 2, function() {
  var user = new JRObject("Users::User", {id : 'admin', password: 'nimda'});
  omega_ws_request('users::login', user, function(res, err){
    equal(null, err);
    equal('Users::Session', res.json_class);
    start();
  });
});

asyncTest("global error handlers", 2, function() {
  var user = new JRObject("Users::User", {id : 'admin', password: 'invalid'});
  add_error_handler(function(msg){
    start();
    equal('invalid user', msg['error']['message']);
  });
  omega_web_request('users::login', user, function(res, err){
    start();
    equal('invalid user', err['message']);
  });
});

asyncTest("method handlers", 1, function() {
  var user = new JRObject("Users::User", {id : 'admin', password: 'nimda'});
  omega_ws_request('users::login', user, null);
  omega_ws_request('motel::track_movement', 10, 5, null); // location 12 corresponds to a planet
  add_method_handler("motel::on_movement", function(location){
    equal(10, location.id);
    omega_ws_request('motel::remove_callbacks', 10, null);
    start();
  });
});

  });
  </script>
  
</head>
<body>
  <h1 id="qunit-header">QUnit example</h1>
 <h2 id="qunit-banner"></h2>
 <div id="qunit-testrunner-toolbar"></div>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
